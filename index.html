<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0D0D0D">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>BOP Expenses</title>
<link rel="manifest" href="manifest.json">
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');

:root {
  --bg: #0D0D0D;
  --surface: #161616;
  --surface2: #202020;
  --surface3: #2A2A2A;
  --accent: #f4db27;
  --accent-dim: rgba(244,219,39,0.12);
  --text: #EFEFEF;
  --muted: #666;
  --danger: #F87171;
  --success: #4ADE80;
  --border: #222;
  --font-ui: 'Inter', system-ui, sans-serif;
  --font-mono: 'Space Mono', 'Courier New', monospace;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font-ui); }

#app { height: 100%; display: flex; flex-direction: column; overflow: hidden; }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.screen.active { display: flex; }

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px;
  padding-top: calc(14px + var(--safe-top));
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: 12px;
}
.topbar-wordmark {
  font-family: var(--font-mono);
  font-size: 15px;
  font-weight: 700;
  letter-spacing: -0.5px;
  line-height: 1;
}
.topbar-wordmark em { color: var(--accent); font-style: normal; }
.topbar-sub { font-size: 11px; color: var(--muted); margin-top: 3px; display: flex; align-items: center; gap: 5px; }
.dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.dot-online { background: var(--success); }
.dot-offline { background: var(--danger); }

.topbar-actions { display: flex; gap: 8px; align-items: center; }
.btn-accent {
  background: var(--accent); color: #000; border: none;
  padding: 8px 14px; border-radius: 8px;
  font-size: 13px; font-weight: 700; cursor: pointer;
  font-family: var(--font-ui); letter-spacing: -0.2px;
  transition: opacity 0.1s;
}
.btn-accent:active { opacity: 0.8; }
.btn-ghost {
  background: none; border: none; color: var(--accent);
  font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: var(--font-ui); padding: 4px 2px;
}
.btn-settings {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--muted); width: 34px; height: 34px;
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 16px; flex-shrink: 0;
}

/* ‚îÄ‚îÄ LIST ‚îÄ‚îÄ */
.scroll-area {
  flex: 1; overflow-y: auto; padding: 14px 16px;
  padding-bottom: calc(90px + var(--safe-bottom));
  -webkit-overflow-scrolling: touch;
}

.receipt-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
  cursor: pointer;
  display: flex; align-items: center; gap: 12px;
  transition: background 0.1s, border-color 0.15s;
  position: relative; overflow: hidden;
}
.receipt-card:active { background: var(--surface2); }
.receipt-card.status-extracted { border-left: 3px solid var(--success); }
.receipt-card.status-pending { border-left: 3px solid var(--accent); }
.receipt-card.status-error { border-left: 3px solid var(--danger); }

.receipt-thumb {
  width: 54px; height: 54px; border-radius: 10px;
  object-fit: cover; background: var(--surface3);
  flex-shrink: 0;
}
.receipt-body { flex: 1; min-width: 0; }
.receipt-desc {
  font-size: 14px; font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 5px;
}
.receipt-meta {
  font-family: var(--font-mono); font-size: 11px; color: var(--accent);
  opacity: 0.75;
}
.status-pill {
  font-size: 10px; font-weight: 700; padding: 3px 8px;
  border-radius: 20px; flex-shrink: 0; text-transform: uppercase;
  letter-spacing: 0.6px;
}
.pill-extracted { background: rgba(74,222,128,0.1); color: var(--success); }
.pill-pending { background: rgba(244,219,39,0.12); color: var(--accent); }
.pill-error { background: rgba(248,113,113,0.1); color: var(--danger); }

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
.fab {
  position: fixed;
  bottom: calc(22px + var(--safe-bottom));
  right: 22px;
  width: 62px; height: 62px; border-radius: 31px;
  background: var(--accent); color: #000;
  border: none; font-size: 30px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 6px 24px rgba(244,219,39,0.4);
  z-index: 100; transition: transform 0.1s, box-shadow 0.1s;
  line-height: 1;
}
.fab:active { transform: scale(0.9); box-shadow: 0 3px 12px rgba(244,219,39,0.3); }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px; padding: 48px 32px; text-align: center;
}
.empty-icon { font-size: 52px; margin-bottom: 8px; }
.empty-h { font-size: 19px; font-weight: 700; }
.empty-p { font-size: 14px; color: var(--muted); line-height: 1.6; }

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
.setup-body {
  flex: 1; padding: 32px 24px;
  display: flex; flex-direction: column; gap: 22px;
  overflow-y: auto;
}
.setup-h { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
.setup-h em { color: var(--accent); font-style: normal; }
.setup-p { font-size: 14px; color: var(--muted); line-height: 1.65; }

/* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
.field { display: flex; flex-direction: column; gap: 7px; }
.field-label {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--muted);
}
.field-input, .field-select {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 13px 14px;
  color: var(--text); font-size: 15px; font-family: var(--font-ui);
  outline: none; width: 100%;
  transition: border-color 0.15s;
  -webkit-appearance: none; appearance: none;
}
.field-input:focus, .field-select:focus { border-color: var(--accent); }
.field-input.mono { font-family: var(--font-mono); font-size: 13px; }

.field-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7' fill='none'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23555' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 13px center;
  padding-right: 36px; cursor: pointer;
}
.field-select option { background: var(--surface2); }

.btn-primary {
  background: var(--accent); color: #000; border: none;
  padding: 15px; border-radius: 12px;
  font-size: 15px; font-weight: 700; cursor: pointer;
  font-family: var(--font-ui); letter-spacing: -0.2px; width: 100%;
  transition: opacity 0.15s;
}
.btn-primary:active { opacity: 0.85; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: var(--surface2); color: var(--text);
  border: 1px solid var(--border); padding: 14px;
  border-radius: 12px; font-size: 14px; font-weight: 500;
  cursor: pointer; font-family: var(--font-ui); width: 100%;
}
.btn-secondary:active { background: var(--surface3); }

.btn-delete {
  background: rgba(248,113,113,0.08); color: var(--danger);
  border: 1px solid rgba(248,113,113,0.2); padding: 14px;
  border-radius: 12px; font-size: 14px; font-weight: 500;
  cursor: pointer; font-family: var(--font-ui); width: 100%;
}

/* ‚îÄ‚îÄ DETAIL SCREEN ‚îÄ‚îÄ */
.detail-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.receipt-image-wrap { width: 100%; background: #000; position: relative; }
.receipt-image-wrap img { width: 100%; max-height: 44vh; object-fit: contain; display: block; }
.detail-form {
  padding: 20px 16px;
  display: flex; flex-direction: column; gap: 15px;
  padding-bottom: calc(24px + var(--safe-bottom));
}

.extracting-bar {
  background: var(--surface2); border-bottom: 1px solid var(--border);
  padding: 10px 16px; display: none;
  align-items: center; gap: 10px; font-size: 13px; color: var(--accent);
  flex-shrink: 0;
}
.extracting-bar.active { display: flex; }
.mini-spinner {
  width: 14px; height: 14px; border-radius: 50%;
  border: 2px solid rgba(244,219,39,0.2);
  border-top-color: var(--accent);
  animation: spin 0.7s linear infinite; flex-shrink: 0;
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-bg {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 200; align-items: flex-end;
}
.modal-bg.active { display: flex; }
.modal-sheet {
  background: var(--surface); border-radius: 22px 22px 0 0;
  width: 100%; max-height: 88vh; overflow-y: auto;
  padding: 24px 20px;
  padding-bottom: calc(24px + var(--safe-bottom));
  display: flex; flex-direction: column; gap: 14px;
}
.modal-handle {
  width: 36px; height: 4px; background: var(--surface3);
  border-radius: 2px; margin: 0 auto 8px;
}
.modal-title { font-size: 19px; font-weight: 700; letter-spacing: -0.4px; }
.modal-sub { font-size: 13px; color: var(--muted); line-height: 1.5; margin-top: -6px; }

.warning-box {
  background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.18);
  border-radius: 10px; padding: 12px 14px;
  font-size: 13px; color: var(--danger); line-height: 1.55;
}

.section-label {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--muted); padding-top: 4px;
}

/* ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ */
.settings-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 0; border-bottom: 1px solid var(--border);
  gap: 12px;
}
.settings-item:last-child { border-bottom: none; }
.settings-item-label { font-size: 14px; font-weight: 500; }
.settings-item-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 50%;
  transform: translateX(-50%) translateY(12px);
  background: var(--surface2); color: var(--text);
  padding: 10px 18px; border-radius: 10px;
  font-size: 13px; font-weight: 500;
  opacity: 0; pointer-events: none; white-space: nowrap;
  z-index: 999; transition: all 0.2s;
  border: 1px solid var(--surface3);
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ CAMERA VIEWFINDER ‚îÄ‚îÄ */
.camera-overlay {
  display: none; position: fixed; inset: 0;
  background: #000; z-index: 500;
  flex-direction: column;
}
.camera-overlay.active { display: flex; }
.camera-video-wrap {
  flex: 1; position: relative; overflow: hidden; min-height: 0;
}
.camera-video-wrap video {
  position: absolute; inset: 0;
  width: 100%; height: 100%; object-fit: cover;
}
.camera-toolbar {
  display: flex; align-items: center; justify-content: center;
  padding: 24px 24px;
  padding-bottom: calc(28px + var(--safe-bottom));
  background: #000; gap: 36px;
  flex-shrink: 0; position: relative; z-index: 10;
}
.camera-btn-capture {
  width: 76px; height: 76px; border-radius: 50%;
  background: #fff; border: 5px solid rgba(255,255,255,0.3);
  cursor: pointer; flex-shrink: 0;
  transition: transform 0.1s;
  -webkit-tap-highlight-color: rgba(255,255,255,0.2);
}
.camera-btn-capture:active { transform: scale(0.88); background: #ddd; }
.camera-btn-close {
  background: none; border: none; color: #fff;
  font-size: 15px; font-weight: 600; cursor: pointer;
  font-family: var(--font-ui); padding: 12px 8px;
}
.camera-switch-btn {
  background: none; border: none; color: #fff;
  font-size: 24px; cursor: pointer; padding: 12px 8px;
}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  display: inline-block; width: 16px; height: 16px;
  border-radius: 50%; border: 2px solid rgba(0,0,0,0.2);
  border-top-color: #000;
  animation: spin 0.65s linear infinite;
  vertical-align: middle; margin-right: 7px;
}

.count-badge {
  background: var(--accent-dim); color: var(--accent);
  font-size: 11px; font-weight: 700; font-family: var(--font-mono);
  padding: 2px 7px; border-radius: 20px;
}
</style>
</head>
<body>
<div id="app">

  <!-- ‚ïê‚ïê HOME SCREEN ‚ïê‚ïê -->
  <div class="screen active" id="screen-home">
    <div class="topbar">
      <div>
        <div class="topbar-wordmark">BOP <em>Expenses</em></div>
        <div class="topbar-sub" id="conn-status">
          <span class="dot dot-online" id="conn-dot"></span>
          <span id="conn-label">Online</span>
          <span style="margin-left:4px;opacity:0.4">¬∑ v9</span>
        </div>
      </div>
      <div class="topbar-actions">
        <button class="btn-accent" id="home-export-btn" onclick="openExportModal()" style="display:none">Export</button>
        <button class="btn-settings" onclick="openSettings()" title="Settings">‚öô</button>
      </div>
    </div>
    <div class="scroll-area" id="home-list">
      <!-- populated by renderHome() -->
    </div>
    <button class="fab" onclick="triggerCamera()">+</button>
  </div>

  <!-- ‚ïê‚ïê DETAIL SCREEN ‚ïê‚ïê -->
  <div class="screen" id="screen-detail">
    <div class="topbar">
      <button class="btn-ghost" onclick="showHome()">‚Üê Back</button>
      <div class="topbar-wordmark" id="detail-title" style="font-size:13px">Receipt</div>
      <div style="width:48px"></div><!-- spacer -->
    </div>
    <div class="detail-scroll">
      <div class="receipt-image-wrap">
        <img id="detail-photo" src="" alt="Receipt photo">
      </div>
      <div class="detail-form">
        <div class="field">
          <div class="field-label">Date</div>
          <input class="field-input mono" type="date" id="detail-date">
        </div>
        <div class="field">
          <div class="field-label">Category</div>
          <select class="field-select" id="detail-desc">
            <option value="Meal">Meal</option>
            <option value="Local travel">Local travel</option>
            <option value="International travel">International travel</option>
            <option value="Stay">Stay</option>
            <option value="Visa">Visa</option>
            <option value="Data">Data</option>
          </select>
        </div>
        <div class="field">
          <div class="field-label">Currency</div>
          <input class="field-input mono" type="text" id="detail-currency" placeholder="EUR" maxlength="3" style="text-transform:uppercase">
        </div>
        <div class="field">
          <div class="field-label">Amount</div>
          <input class="field-input" type="number" id="detail-amount" placeholder="0.00" step="0.01" min="0">
        </div>
        <button class="btn-primary" onclick="saveDetail()">Save</button>
        <button class="btn-delete" onclick="confirmDelete()">Delete Receipt</button>
      </div>
    </div>
  </div>

  <!-- Hidden camera input (fallback) -->
  <input type="file" id="camera-input" accept="image/*" capture="environment"
         style="position:absolute;opacity:0;pointer-events:none" onchange="handlePhoto(event)">

  <!-- Camera viewfinder overlay -->
  <div class="camera-overlay" id="camera-overlay">
    <div class="camera-video-wrap">
      <video id="camera-video" autoplay playsinline muted></video>
    </div>
    <canvas id="camera-canvas" style="display:none"></canvas>
    <div class="camera-toolbar">
      <button class="camera-btn-close" onclick="closeCamera()">Cancel</button>
      <button class="camera-btn-capture" onclick="capturePhoto()"></button>
      <button class="camera-switch-btn" onclick="switchCamera()">üîÑ</button>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê EXPORT MODAL ‚ïê‚ïê -->
<div class="modal-bg" id="export-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Export Report</div>
    <div class="modal-sub" id="export-summary">Preparing‚Ä¶</div>
    <div class="warning-box" id="export-warn" style="display:none"></div>
    <div class="field">
      <div class="field-label">Phase Number</div>
      <input class="field-input mono" type="text" id="export-phase" placeholder="e.g. Phase 2 or 3B">
    </div>
    <div id="rate-fields-wrap" style="display:flex;flex-direction:column;gap:12px"></div>
    <!-- Step 1: Build -->
    <button class="btn-primary" id="export-build-btn" onclick="buildExportFiles()">Build Export</button>
    <!-- Step 2: Download / Share (hidden until built) -->
    <div id="export-actions" style="display:none;flex-direction:column;gap:10px">
      <div style="font-size:13px;color:var(--success);text-align:center;padding:4px 0">‚úì Files ready</div>
      <button class="btn-primary" id="export-dl-btn" onclick="downloadExportFiles()">‚¨á Download Files</button>
      <button class="btn-secondary" id="export-share-btn" onclick="shareExportFilesBtn()" style="display:none">üì§ Download &amp; Share via App</button>
    </div>
    <div id="export-error" class="warning-box" style="display:none;font-family:var(--font-mono);font-size:11px;word-break:break-all"></div>
    <button class="btn-secondary" onclick="closeExportModal()">Cancel</button>
  </div>
</div>

<!-- ‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê -->
<div class="modal-bg" id="settings-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>
    <div class="settings-item">
      <div>
        <div class="settings-item-label">Total receipts stored</div>
        <div class="settings-item-sub" id="settings-receipt-count">0 receipts</div>
      </div>
    </div>
    <div class="settings-item">
      <div>
        <div class="settings-item-label">Clear all data</div>
        <div class="settings-item-sub">Deletes all receipts from this device</div>
      </div>
      <button class="btn-delete" style="width:auto;padding:8px 14px;font-size:13px" onclick="clearAllData()">Clear</button>
    </div>
    <button class="btn-secondary" onclick="closeSettings()">Close</button>
  </div>
</div>

<!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê SCRIPTS ‚ïê‚ïê -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DB
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let db = null;
const DB_NAME = 'bop-v1';

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('receipts')) {
        d.createObjectStore('receipts', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('settings')) {
        d.createObjectStore('settings', { keyPath: 'key' });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function tx(store, mode, fn) {
  return new Promise((resolve, reject) => {
    const t = db.transaction(store, mode);
    const req = fn(t.objectStore(store));
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

const dbGet    = (s, k) => tx(s, 'readonly',  st => st.get(k));
const dbPut    = (s, v) => tx(s, 'readwrite', st => st.put(v));
const dbDel    = (s, k) => tx(s, 'readwrite', st => st.delete(k));
const dbGetAll = (s)    => tx(s, 'readonly',  st => st.getAll());
const dbClear  = (s)    => tx(s, 'readwrite', st => st.clear());

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let receipts   = [];
let currentId  = null;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  db = await openDB();
  await loadReceipts();
  showScreen('home');
  renderHome();
  setupConnectivity();
}

function setupConnectivity() {
  updateConn();
  window.addEventListener('online',  updateConn);
  window.addEventListener('offline', updateConn);
}

function updateConn() {
  const on = navigator.onLine;
  document.getElementById('conn-dot').className = 'dot ' + (on ? 'dot-online' : 'dot-offline');
  document.getElementById('conn-label').textContent = on ? 'Online' : 'Offline';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOAD RECEIPTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadReceipts() {
  receipts = await dbGetAll('receipts');
  receipts.sort((a, b) => b.createdAt - a.createdAt);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER HOME
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome() {
  const list      = document.getElementById('home-list');
  const exportBtn = document.getElementById('home-export-btn');
  const saved     = receipts.filter(r => r.status === 'saved');

  exportBtn.style.display = saved.length > 0 ? 'block' : 'none';

  if (receipts.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üßæ</div>
        <div class="empty-h">No receipts yet</div>
        <div class="empty-p">Tap <strong style="color:var(--accent)">+</strong> to photograph your first receipt. Works offline too.</div>
      </div>`;
    return;
  }

  list.innerHTML = receipts.map(r => {
    const isSaved = r.status === 'saved';
    const desc    = isSaved ? (r.description || '‚Äî') : 'Tap to fill in details';
    const meta    = isSaved
      ? `${r.currency || '?'} ${parseFloat(r.amount || 0).toFixed(2)} ¬∑ ${formatDateDisplay(r.date) || '?'}`
      : new Date(r.createdAt).toLocaleDateString('en-GB');
    const pillClass = isSaved ? 'pill-extracted' : 'pill-pending';
    const pillLabel = isSaved ? 'saved' : 'draft';
    const cardClass = isSaved ? 'status-extracted' : 'status-pending';

    return `
      <div class="receipt-card ${cardClass}" onclick="openDetail('${r.id}')">
        <img class="receipt-thumb" src="${r.photoBase64}" alt="" onerror="this.style.opacity='0'">
        <div class="receipt-body">
          <div class="receipt-desc">${esc(desc)}</div>
          <div class="receipt-meta">${esc(meta)}</div>
        </div>
        <span class="status-pill ${pillClass}">${pillLabel}</span>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CAMERA + PHOTO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cameraStream = null;
let useFrontCamera = false;

async function triggerCamera() {
  // Try getUserMedia first (opens camera directly, no file picker)
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    try {
      await openCameraViewfinder();
      return;
    } catch (err) {
      console.warn('getUserMedia failed, falling back to file input:', err);
    }
  }
  // Fallback: file input with capture attribute
  document.getElementById('camera-input').click();
}

async function openCameraViewfinder() {
  const video = document.getElementById('camera-video');
  const constraints = {
    video: {
      facingMode: useFrontCamera ? 'user' : 'environment',
      width: { ideal: 1920 },
      height: { ideal: 1080 }
    },
    audio: false
  };

  cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = cameraStream;
  await video.play();
  document.getElementById('camera-overlay').classList.add('active');
}

function closeCamera() {
  document.getElementById('camera-overlay').classList.remove('active');
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
  document.getElementById('camera-video').srcObject = null;
}

async function switchCamera() {
  useFrontCamera = !useFrontCamera;
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
  }
  try {
    await openCameraViewfinder();
  } catch (err) {
    useFrontCamera = !useFrontCamera;
    showToast('Could not switch camera');
  }
}

async function capturePhoto() {
  const video = document.getElementById('camera-video');
  const canvas = document.getElementById('camera-canvas');

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  closeCamera();
  showToast('Saving photo‚Ä¶');

  const base64 = await resizeCanvasToBase64(canvas, 1400);
  await createReceipt(base64);
}

function resizeCanvasToBase64(srcCanvas, maxDim) {
  return new Promise(resolve => {
    let w = srcCanvas.width, h = srcCanvas.height;
    if (w > maxDim || h > maxDim) {
      if (w >= h) { h = Math.round(h * maxDim / w); w = maxDim; }
      else        { w = Math.round(w * maxDim / h); h = maxDim; }
    }
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(srcCanvas, 0, 0, w, h);
    resolve(c.toDataURL('image/jpeg', 0.88));
  });
}

async function handlePhoto(event) {
  const file = event.target.files[0];
  event.target.value = '';
  if (!file) return;

  showToast('Saving photo‚Ä¶');
  const base64 = await resizeToBase64(file, 1400);
  await createReceipt(base64);
}

async function createReceipt(base64) {
  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD for date input
  const receipt = {
    id:          'r' + Date.now() + Math.random().toString(36).slice(2, 6),
    photoBase64: base64,
    status:      'draft',
    createdAt:   Date.now(),
    date:        today,
    currency:    '',
    amount:      '',
    description: 'Meal'
  };

  await dbPut('receipts', receipt);
  receipts.unshift(receipt);
  renderHome();
  openDetail(receipt.id);
}

function resizeToBase64(file, maxDim) {
  return new Promise(resolve => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        if (w >= h) { h = Math.round(h * maxDim / w); w = maxDim; }
        else        { w = Math.round(w * maxDim / h); h = maxDim; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL('image/jpeg', 0.88));
    };
    img.src = url;
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DETAIL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDetail(id) {
  currentId = id;
  const r = receipts.find(x => x.id === id);
  if (!r) return;
  renderDetail(r);
  showScreen('detail');
}

function renderDetail(r) {
  const num = receipts.findIndex(x => x.id === r.id) + 1;
  document.getElementById('detail-title').textContent = `Receipt #${num}`;
  document.getElementById('detail-photo').src    = r.photoBase64 || '';
  document.getElementById('detail-date').value  = r.date || '';
  document.getElementById('detail-currency').value = r.currency || '';
  document.getElementById('detail-amount').value = r.amount || '';
  document.getElementById('detail-desc').value  = r.description || 'Meal';
}

async function saveDetail() {
  const r = receipts.find(x => x.id === currentId);
  if (!r) return;

  const date     = document.getElementById('detail-date').value.trim();
  const currency = document.getElementById('detail-currency').value.toUpperCase().trim();
  const amount   = document.getElementById('detail-amount').value;

  if (!date || !currency || !amount) {
    showToast('Fill in date, currency and amount');
    return;
  }

  r.date        = date;
  r.currency    = currency;
  r.amount      = amount;
  r.description = document.getElementById('detail-desc').value;
  r.status      = 'saved';

  await dbPut('receipts', r);
  const idx = receipts.findIndex(x => x.id === currentId);
  if (idx >= 0) receipts[idx] = r;

  showToast('Saved ‚úì');
  showHome();
}

async function confirmDelete() {
  if (!confirm('Delete this receipt?')) return;
  await dbDel('receipts', currentId);
  receipts = receipts.filter(r => r.id !== currentId);
  showToast('Deleted');
  showHome();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  EXPORT MODAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openExportModal() {
  const saved   = receipts.filter(r => r.status === 'saved');
  const drafts  = receipts.filter(r => r.status === 'draft').length;

  document.getElementById('export-summary').textContent =
    `${saved.length} receipt${saved.length !== 1 ? 's' : ''} ready to export`;

  const warnEl = document.getElementById('export-warn');
  if (drafts > 0) {
    warnEl.style.display = 'block';
    warnEl.textContent = `${drafts} receipt(s) are drafts (missing details) ‚Äì not included.`;
  } else {
    warnEl.style.display = 'none';
  }

  // Rate fields per unique currency
  const currencies = [...new Set(saved.map(r => r.currency).filter(Boolean))];
  const wrap = document.getElementById('rate-fields-wrap');
  if (currencies.length > 0) {
    wrap.innerHTML = `
      <div class="section-label">Exchange Rates to Local Currency</div>
      ${currencies.map(c => `
        <div class="field">
          <div class="field-label">1 ${c} =</div>
          <input class="field-input mono" type="number" id="rate-${c}"
                 placeholder="1.0000" step="0.0001" value="1" inputmode="decimal">
        </div>`).join('')}`;
  } else {
    wrap.innerHTML = '';
  }

  document.getElementById('export-modal').classList.add('active');
}

function closeExportModal() {
  document.getElementById('export-modal').classList.remove('active');
  resetExportModal();
}

// Export state
let exportedXlsxBlob = null;
let exportedPdfBlob = null;
let exportedXlsxName = '';
let exportedPdfName = '';

async function buildExportFiles() {
  const phase = document.getElementById('export-phase').value.trim();
  if (!phase) { showToast('Enter a phase number'); return; }

  const saved = receipts.filter(r => r.status === 'saved');
  if (!saved.length) { showToast('No saved receipts to export'); return; }

  const currencies = [...new Set(saved.map(r => r.currency).filter(Boolean))];
  const rates = {};
  currencies.forEach(c => {
    const el = document.getElementById('rate-' + c);
    rates[c] = el ? (parseFloat(el.value) || 1) : 1;
  });

  const btn = document.getElementById('export-build-btn');
  const errEl = document.getElementById('export-error');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Building‚Ä¶';
  errEl.style.display = 'none';

  try {
    const xlsxBytes = await buildExcel(saved, phase, rates);
    const pdfBytes  = await buildPDF(saved);
    const ts        = new Date().toISOString().slice(0, 10);

    exportedXlsxName = `BOP_Expenses_${ts}.xlsx`;
    exportedPdfName  = `BOP_Receipts_${ts}.pdf`;
    exportedXlsxBlob = new Blob([xlsxBytes], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    exportedPdfBlob  = new Blob([pdfBytes],  { type: 'application/pdf' });

    // Hide build button, show action buttons
    btn.style.display = 'none';
    const actions = document.getElementById('export-actions');
    actions.style.display = 'flex';

    // Show share button only if the API exists
    const shareBtn = document.getElementById('export-share-btn');
    if (navigator.share) {
      shareBtn.style.display = 'block';
    }

  } catch (err) {
    errEl.textContent = 'Build failed: ' + err.name + ': ' + err.message;
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.innerHTML = 'Build Export';
  }
}

function downloadExportFiles() {
  if (!exportedXlsxBlob || !exportedPdfBlob) return;
  try {
    dlBlob(exportedXlsxBlob, exportedXlsxName);
    setTimeout(() => {
      dlBlob(exportedPdfBlob, exportedPdfName);
      showToast('2 files downloaded ‚Üì');
    }, 600);
  } catch (err) {
    showExportError('Download error: ' + err.name + ': ' + err.message);
  }
}

async function shareExportFilesBtn() {
  if (!exportedXlsxBlob || !exportedPdfBlob) return;
  const errEl = document.getElementById('export-error');
  errEl.style.display = 'none';

  // Step 1: Download the files first (always works)
  dlBlob(exportedXlsxBlob, exportedXlsxName);
  await sleep(500);
  dlBlob(exportedPdfBlob, exportedPdfName);

  // Step 2: Try native share sheet
  try {
    const pdfFile  = new File([exportedPdfBlob],  exportedPdfName,  { type: exportedPdfBlob.type });
    const xlsxFile = new File([exportedXlsxBlob], exportedXlsxName, { type: exportedXlsxBlob.type });

    // Try sharing both files
    if (navigator.canShare && navigator.canShare({ files: [pdfFile, xlsxFile] })) {
      await navigator.share({ files: [pdfFile, xlsxFile] });
      closeExportModal();
      return;
    }
  } catch (err) {
    if (err.name === 'AbortError') { closeExportModal(); return; }
    // Share failed ‚Äî files already downloaded, show guidance
  }

  // If share didn't work, guide the user
  showExportError('‚úì Files saved to Downloads. Open WhatsApp/Signal ‚Üí tap üìé ‚Üí attach from Downloads.', true);
}

function showExportError(msg, isInfo) {
  const errEl = document.getElementById('export-error');
  errEl.textContent = msg;
  errEl.style.display = 'block';
  if (isInfo) {
    errEl.style.background = 'rgba(74,222,128,0.08)';
    errEl.style.borderColor = 'rgba(74,222,128,0.18)';
    errEl.style.color = 'var(--success)';
  } else {
    errEl.style.background = '';
    errEl.style.borderColor = '';
    errEl.style.color = '';
  }
}

function resetExportModal() {
  exportedXlsxBlob = null;
  exportedPdfBlob = null;
  const btn = document.getElementById('export-build-btn');
  btn.style.display = 'block';
  btn.disabled = false;
  btn.innerHTML = 'Build Export';
  document.getElementById('export-actions').style.display = 'none';
  document.getElementById('export-share-btn').style.display = 'none';
  document.getElementById('export-error').style.display = 'none';
}

function dlBlob(blob, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  EXCEL BUILDER (matches BOP template exactly)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Column index: A=0 B=1 C=2 D=3 E=4 F=5 G=6 H=7 ... N=13 O=14 P=15 Q=16 R=17

function formatDateDisplay(isoDate) {
  if (!isoDate) return '';
  const parts = isoDate.split('-');
  if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
  return isoDate;
}

function emptyRow() {} // removed

async function buildExcel(data, phase, rates) {
  // Embedded BOP template (base64)
  const TPL = 'UEsDBBQABgAIAAAAIQCeLGxvawEAABAFAAATAAgCW0NvbnRlbnRfVHlwZXNdLnhtbCCiBAIooAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACslMFOwzAMhu9IvEOVK2qzcUAIrdthwBEmMR4gJO4aLU2iOBvb2+NmY0KorELrpVEb+/+/uHYms11jsi0E1M6WbFyMWAZWOqXtqmTvy+f8nmUYhVXCOAsl2wOy2fT6arLce8CMsi2WrI7RP3COsoZGYOE8WNqpXGhEpNew4l7ItVgBvx2N7rh0NoKNeWw12HTyCJXYmJg97ejzgSSAQZbND4GtV8mE90ZLEYmUb6365ZIfHQrKTDFYa483hMF4p0O787fBMe+VShO0gmwhQnwRDWHwneGfLqw/nFsX50U6KF1VaQnKyU1DFSjQBxAKa4DYmCKtRSO0/eY+45+CkadlPDBIe74k3MMR6X8DT8/LEZJMjyHGvQEcuuxJtM+5FgHUWww0GYMD/NTu4ZDCyHlNLTJwEU665/ypbxfBeaQJDvB/gO8RbbNzT0IQoobTkHY1+8mRpv/iE0N7vyhQHd483WfTLwAAAP//AwBQSwMEFAAGAAgAAAAhALVVMCP0AAAATAIAAAsACAJfcmVscy8ucmVscyCiBAIooAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACskk1PwzAMhu9I/IfI99XdkBBCS3dBSLshVH6ASdwPtY2jJBvdvyccEFQagwNHf71+/Mrb3TyN6sgh9uI0rIsSFDsjtnethpf6cXUHKiZylkZxrOHEEXbV9dX2mUdKeSh2vY8qq7iooUvJ3yNG0/FEsRDPLlcaCROlHIYWPZmBWsZNWd5i+K4B1UJT7a2GsLc3oOqTz5t/15am6Q0/iDlM7NKZFchzYmfZrnzIbCH1+RpVU2g5abBinnI6InlfZGzA80SbvxP9fC1OnMhSIjQS+DLPR8cloPV/WrQ08cudecQ3CcOryPDJgosfqN4BAAD//wMAUEsDBBQABgAIAAAAIQB/+yDPmQMAAPEIAAAPAAAAeGwvd29ya2Jvb2sueG1srFVtT+M4EP5+0v0HK99D4ry0aURZ5a06TrBCpQt3q0rIJC6xSOKc7dAitP99x2lTYHs6ddmrWrv2TB4/M/OMc/ppU1foiQrJeDM18IltINrkvGDNw9T4spiZgYGkIk1BKt7QqfFMpfHp7PffTtdcPN5z/ogAoJFTo1SqDS1L5iWtiTzhLW3AsuKiJgqW4sGSraCkkCWlqq4sx7ZHVk1YY2wRQnEMBl+tWE5Tnnc1bdQWRNCKKKAvS9bKAa3Oj4GriXjsWjPndQsQ96xi6rkHNVCdh+cPDRfkvoKwN9hHGwHfEfywDYMznASmg6Nqlgsu+UqdALS1JX0QP7YtjN+lYHOYg+OQPEvQJ6ZruGclRh9kNdpjjV7BsP3LaBik1WslhOR9EM3fc3OMs9MVq+jNVrqItO1nUutKVQaqiFRZwRQtpsYYlnxN322Iro07VoHVmWBnbFhnezlfCVTQFekqtQAhD/DgaDuubWtPEEZUKSoaomjCGwU63MX1q5rrsZOSg8LRnP7TMUGhsUBfECuMJA/JvbwiqkSdqKZGEi6/SAh/+SeVkqIn0gB19BV6dTk0iFzGvGVNvgxOUFa3FX/WbbNMaV4RAYqncvlGxuSwZ35CyCTX2bEgPdsQtv9/TBVEIsJBrFdKIPh/nl5Awa7JE5QPRFLsuvsc6oPduyYXIb57yRLbDvzUM/1x7JleGmMzCoLMjEaxY2dugpPA+QbBiFGYc9KpcqcMDT01PJDBgemSbAYLtsOOFa80Xuzdx9TzD8Ng+6YD1nfgDaNr+aohvUSbW9YUfD01TGy7Bnp+v1z3xltWqBK05WBvYqDt3h+UPZTAGLtwQ2rSjmY2NV7GSTRzs8QzU9/DpufGgRlHrm8GI5xGGY4TN0h7RtYbSv1tC9T6GTV9h1zrGxjDta7nPskGEqE+Q5wXuC/i8FhOqhw6Qk+94wTbzkR70I26kKqfQYwM6GHPjsb2xDOhGL7pBRPHDDzXMRMvdTJ/nKVZ7Ov66LdF+H/cmX1PhMNrSLMsiVALQfJHeHnN6SomEgS1DQj4viUb+0Fsu0DRm+GZ6eGJbcbxCLSVzlx/jNMk82evZHX4qw/eWIHVP02J6qCbdSP361CPs93ufnO13djV6V3vhfNU53339H85XkP0FT3SeXZzpGPy+XJxeaTvRba4u50d6xxdxml0vH80n0d/L7K/hiOsf02o1Rdcj71MrUEmZ98BAAD//wMAUEsDBBQABgAIAAAAIQCSB5TsBAEAAD8DAAAaAAgBeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHMgogQBKKAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACskstqxDAMRfeF/oPRvnEyfVCGcWbRUphtm36AcJQ4TGIHW33k72tSOsnAkG6yMUjC9x6Ju9t/d634JB8aZxVkSQqCrHZlY2sF78XLzSOIwGhLbJ0lBQMF2OfXV7tXapHjp2CaPoioYoMCw9xvpQzaUIchcT3ZOKmc75Bj6WvZoz5iTXKTpg/SzzUgP9MUh1KBP5S3IIqhj87/a7uqajQ9O/3RkeULFjLw0MYFRIG+JlbwWyeREeRl+82a9hzPQpP7WMrxzZYYsjUZvpw/BkPEE8epFeQ4WYS5XxNGY6ufDDZ2gjm1li5yt2ooDHoq39jHzM+zMW//wciz2Oc/AAAA//8DAFBLAwQUAAYACAAAACEA6lOHcQsTAAC7bwAAGAAAAHhsL3dvcmtzaGVldHMvc2hlZXQxLnhtbJyUXY+iMBSG7zfZ/9D0nm9EIOLEjzEzd5v9mN3bWoo0Uuq21dFs5r/vAYQx8UZNkFRan/c957w4eTqKCh2Y0lzWGfZsFyNWU5nzepPhXz9XVoyRNqTOSSVrluET0/hp+vXL5F2qrS4ZMwgItc5wacwudRxNSyaItuWO1bBTSCWIga9q4+idYiRvfyQqx3fdyBGE17gjpOoWhiwKTtlS0r1gtekgilXEgH9d8p3uaYLeghNEbfc7i0qxA8SaV9ycWihGgqavm1oqsq6g7qMXEoqOCi4fPkEv0z6/UhKcKqllYWwgO53n6/ITJ3EIHUjX9d+E8UJHsQNvBviJ8h+z5I0Glv8JCx6ERQOsaZdK9zzP8L/Fyk1W/ty1kvg5ssLxfGzN5smz5XrxcjmLkiRaBB94Osk5TLipCilWZHjmpW/hCDvTSRugN87e9cUaGbL+wSpGDQMRD6Mmn2spt83BV3jkAlK3BxokoYYf2IJVVYZffAi9/tur/FktPTeMR+OoEXMGtct1r7xq0/1NoZwVZF+Zhax+89yU4CC0w8hNgvEI95vf5fsL45vSwK5vQy2oDU+an5ZMU0gzmLSDRpTKChTgjgRv3koIIzl2VXV03x5Ho8gHhDanJp4RRnSvjRS9/BnTAWCWHaDpy9mfa8dh6+4mgjcgYJRnRHifCS/sXYDtB11AmV0h8K/UI+7shZf0DFicGfe2E/LS2YiCGKrqnVyMfGhqE6F2nP8BAAD//wAAAP//rJxbc9vIEYX/iopPSapiiaSuLklVMUmAxIUEgWzeVVo53krtOmU5m82/zwBzGtMzZwCSlvwi14ee5gB9pjE4vNy/fnl5+b58+v70eP/t63/Pvj1MppOz138//fZq/vdxNpucffn+MJlffLi8mpx9//LL878+fTXABP0xvXx6/vjz/5Yvr88vvxl28WF+NXm8f26T/K3N0oadA3yy4ObCZHmYvJq43x8v7s9/f7w/f0bIog+RQUsiKyIJkZTImsjGklk/vywEuQXzPqIIQRkO2eJlzJ/+HKf+Oe76EDnHisieSE2kseSyn93fLbjqwU8h+IcC56bWfcFNjb2Ct3WbT86e//P6/euvyddvvz4NF7yvd5vkYXLj6m3BbQ8WIViGYBWCxIK7PkcagnUINiHIQpCHoAhBacH0on/dbRiyQ4jTd4UL4BS1J1ITaZCnG+UVxRTgqKK0q3N68+H6Qv8zlY6tzr5YbXKvWBZML5VwZ8HiRIg74yWymD+92uf+oFUfImpPiKRE1kQ2ljghZCHIQ1CEoMQJqKqGITs6xwpTUVUlUhNpkIerai7w25dam8SrngVqqSHCdYclkRWRhEhKZG2JK8QmBFkI8hAUISgt0OstDNkhRK03zE1VhkhNpEEeroy5u729Mm0SrzIWTNtbp9z0LoN1hTE65MoPWSLkuu9HK+R1JAG5Ua907adJ+xBZjGskdl17QyQjkhMpkNkpsARxQtlGLsVNcG+0ITO3QisQfUO99QftEWIaaX+J7/yQ+nCWBrNjXVy/hy7aJJ4uLJjp1jkNd0OIGTn3JULcOl+BuG1AEnupYFOS9jG9MjBjpQwiGZGcSGHJVCkDRCkDr27+uF1TcPfZIUZJg15rT6Qm0uDVuc5m4bx9/bdJvDpbMHOXcQHiLsgSxF2QFYgqIuVJiayJbIhkRHIiBZHSkrm6c9IMd4hRDZrInkhNeRpLplygWy7Q3Cx62qV2G6JZ97hij61ffvlnBw9sitoX8Ipngde8p8EGZ4FB5o/TbtDhl32MrK4VkYRISmRNZEMkI5LjLNytoiBSEtkiz50+r+C2tOtj+kcZS271M940uAvt+xgZVRNpMB8WgZnP21dpm8QrtAVTtwIXRJZEVkQSIimRNZENkYxITqQgUhLZEtkRqYjsidREGhAukNnEUYXmpulGl+ls/qFdXact0+4VjCPhHsw/CTKbO7cKg83FIhoUbCaWCLr1nuCD7cRKgtzWMxHkJpXGUs2Ce/yaU20YZYxyRgWjkqe1jU6LTIq2ig+TW3c6VezyzYK79D4aFLTMOhoU9MxGgrp7oPdgPG1tDO1PmYlGbwSjT8BdFq8JgMxvOmsquCILOWo6Uy8xEo81WG61DGdB01wh0a26uQtyLToV5DYOa0Fu57BhlDHKGRWMSkFqXybIO5+gne948pVcq7uYybfH0cuL2HWu5ejUHP3cXeovT99efp6cfXv5/DAxhz/WZh9y9vqLsRsnj+al/mIS3p9/jtiJDXJF9hIGvYeGYOcoj9OSy1l3bqGD0r2qEeuohmyGAxpCkNYQkNYQkNYQkNYQoQzzvHVROaOCUSlIayh2PqQhmnwl12pAQ7jOAxrCUdKQVY3Zd5D13OD1YlppzZy39xuYREorlqDfhPvK1oBtG9uoVmzMAa0gSGsFSGsFSGsFSGuFUIZ5elqhqIKjSkFaK7HzIa3Q5Cu5VgNasQOG+g2OnqQVOyamldZeertWYFsprViCvhI6SK1te1ArNuaAVhCktQKktQKktQKktUIowzw9rVBUwVGlIK2V2PmQVmjylVyrAa3gOg/0FRw9SSt2TEwrreX0dq3AjFNasQR9Jdh+LNr99kGt2JgDWkGQ1gqQ1gqQ1gqQ1gqhDPP0tEJRBUeVgrRWYudDWqHJV3KtBrRiBwz1FRw9SSt2TEwrrW31dq3ADlNasQR9Jbgki6k9On4PsjEHtIIgrRUgrRUgrRUgrRVCGebpaYWiCo4qBWmtxM6HtEKTr+RaDWgF13mgr+DoSVqxY2JaaR000YrxNLrlHjPKxp+PrA+n3s+dwr2zz0f0dI2jo/sVG3NAKwjSWgHSWgHSWgHSWiGU4Sw8rVBUwVGlIK2V2PmQVmjylVzJAa3YAUN9BUdP0sqgp2p8+ffQCoxA1VcsQV8JnpMX3ase2tvCFDS3z/55m5+lEaS1AqS1AqS1AqS1QijDPD2tUFTBUaUgrZXY+ZBWaPKVXKsBreA6D/QVHD1JK3ZMrK+0reTtfcU2JN1X0KJsXwm8toU0sNG+YjMc6CsI0loB0loB0loB0lohlGGenlYoquCoUpDWSux8SCs0+Uqu1YBW7IChvoKjJ2ll0AU2b+G+g1a6LP5niqwvib5C75hiwOiGBTHjYpEgJRZBSiyClFgEKbEwyhjljApGpSAlluj5hGLhyVdyreJiwdEBscjRU8SCMZHGMtOG7g9vWLosvlisHSuGbujoYsC4WI5xdJFIO7qCtFiQSosFSIuFUCa5lBvHqGBUCtJiiZ0PiQVBbvKVXKsBsdgBQ2LB0ZPEYsfExKKd2x8XCzm37QddzXOxdJbQusXhcbEcY90ikScWtm4lSouFrVuJcsrIGOWMCkalIC2WY6xbGafFYsfNB8Qyat1KGU4Si80YE4u2bn9cLGTdtp/baU0UvFUUerdyeGzPgpgDtyH2bmWc7izs3UqU7izs3XJUzqhgVArSYjnGu+XJV3KtBsQy6t1i7OVJYhn0bmetU/fm/W2Xxb8Ned7tNDRvMWC8sxxj3iKR11nYvJUo3VnYvJUo3VkoKueoglEpSIvlGPNWxunOYscNdZZR8xbpThPLoHk70+btj3cWMm+7vK6zhO6tHB7tLMe4t0jkiYXdW4nSYmH3VqK0WCgq56iCUSlIi+UY91bGabHYcUNiGXVvke40sQy6tzPt3v64WMi97fK6PUto3+LweGc5xr5FIk8sbN9KlBYL27cSpcVCUTlHFYxKQVosx9i3Mk6LxY4bEsuofStlOOk2NGjfms+KvsdtiOzbLq/rLKF/K4dHO8sx/i0SeWJh/1aitFjYv5UoLRaKyjmqYFQK0mI5xr+VcVosdtyQWEb9W6Q7rbMM+rez1q17+57Fen7Kk+vyus4SGrg4PN5ZYoZn+GEoJPLEQh5oKlFaLGzgSpQWC0XlHFUwKgVpsRxj4Mo4LRY7bkgsowaulOGkzjJo4M7excDtsvgbXM/AnYYOLgaMi+UYBxeJPLGwgytRWizs4EqUFgtF5RxVMCoFabEc4+DKOC0WXMqBp6FRBxfpTussgw5u9yG7N3eWLov/RUPPwQ0/D7vAgFGxIGb80VmClIMrSD06C1JiEaQenRlljHJGBaNSkBJL9HxCU44nX8m1iosFRwdMOTl6SmfBmIjPMn8XB7fL4osF1qH7GPICQZcOLRmtGCWMUkZrRhtGGaOcUcGoZLRltBPkvfcZbNgqCeoq+Nj8VP7JfBj2oxHFn+Ofht3LALcias6BD9gO5GgwICaBd/Fl289xB19Mhl2oJQDk1vES45QqVowSRimjNaMNo4xRzqhgVDLaMtoJ8iQQbMMqCXLfudoL0kUes2MbDIhV9F3MU/M1jbCi8PR0RQktMc6rKEUlHJUyWjPaMMoY5YwKRiWjLaOdIK+iwV6pkiB3P9oLcvej2kWZz8g/mlX813pu3rCIfgYesbH6vovfObcWmXp2ALl0d7gFoyWjFaOEUcpozWjDKGOUMyoYlYy2jHaMKqAr973JPUfVEuVWcQMUK1roO47/zIO1pK7cF5U+mV9oadfjlV59hJYctWKUMEoFuW8kr4Hu9JcC58H3oDYS5C5CxihnVAhyp1jyHLYS5c56x6hitGdUS3rXYhtB3R3J/xWP0Pobr5d1hbx6ARkLwP3IRvhWdvsFu/bNS7fkloxWjBIgpYZUkK4g5qC3xEAuKuOBOaNCkJtqyVFbRjtGFaM9o5rPsREUqVfovo3XyxozXr2AvHrRT6n0Qf0PHZn3Ert16RrpSpATbcIoFaTrhVy6XkC6XoRyzlUI0vWigVseuGNUMdozqvkcG0GReoUG2A9/+7t95Gwbo+6VQF4twzd7Me7aNfkl0J2+1c+D9/1WLsj9NI59PTNOUCqz0tXFrHR1gXR1CeWcqxCkq0sDtzxwx6hitGdUC3KibgRFqhs6VuOr0ZoZXgWB3KpaGCMuuAEuga7dzWfFUQmjVJCuDtLr6gDp6hDKOVchSFeHBm554I5RxWjPqOZzbARxdYy14JvPo9Xpov31JUhVR5B6vAfS1eGohFEqSFVHkKoOR2WMckaFIFUdjtoy2jGqGO0Z1XyOjaBIdUJPZrw61mnRa8cYieFOkdGS0YpRwigVpKuDV9TVAVJrhwfmjApBujqUa8sDd4wqRntGNZ9jIyhSndAuGa+OfYT3qmPRtfnj9oXhxwXMp9nCXsdoxShhlArS9cIc3GLdIOpa1wtRDuUcVQhyu+qSX3HLaMeoYrRnVMsruht+I1GReoVmyHi9rFPh1cuia2daLYy30VZHoSWjFaOEUcpozWjDKGOUMyoYlYy2jHaMKkZ7RjWjBugqUp3QysAu0NwsT/jF0ktrZVwrL0OQ60gLRktGK0YJo5TRmtGGUcYoZ1QwKhltGe0YVYz2jGpGjaCuEXvPxu0PynpvXo+vKetSqNXyqUvgLaAFoyWjFaOEUcpozWjDKGOUMyoYlYy2jHaMKkZ7RjWjxkO2OufuF4H/DwAA//8AAAD//8xYYW+iQBD9K4RPmqCAKHJETSrWnJdcNbR/YA9W4Iost6xRc+l/v6ENLXupsqy95vwEhoE3M29m3s4kIFmYsIRkKF0SukOMJVmkFL8o3k5Vz1Znk2Dr71OssFOOpyo8zlCSFQ/4yFQlPG5X4VQdmKqS04TQhJ2mqjlQFZJjihihfxswMJuqYajvdvoJfvD6LXx1n6LZ3fqhs7q/9f2137m/vfG9r536g5pnd7vdiV49PtFfcAnhMzh8lig+QXTqNdjMLxy24edh099NPcTzIiNM0/UsQ4gWplN3Dfz8F6wwTWlamGMu9EASMYDitLgGnM2Bgwr7NHByxLDchSVGixHnGdxd9myTYlRgpcApDphCaISypEBly2pIxAVDzbPO0EbO+ZG7GIk5DwVea5WNRcH7cCJ7qmRoh1t5/maleSP5aoG2+YZ80Fgt/xFyGEg15I2l9FnI5ajmuN8cMapxU7lxKPNesxhDzMhPKLlWXKvbaZ4jzzZ+ZMMkadMkShQUugbJlM6c5EkWKBHOQJKk0D8qv7qtHRN45XmfpbK9gHG7FBy3vJBoF7A8hhbbKh4vFhoAlM4xJw8GLQkaIIYjQpsUJM/qV6MLuKXydAd5WgvmiVcdMObbMDvYU4qzoKXblZEGOD9y7m3Ehh4nZRodljodbOQHGydHIDkfrLOuQMZphcYWWMVNWJ6eRSZVAhvH9cUGEyckShHepgCexUxKAmjlUrXwnr22OTeopCLhi1UFp0qEz6Stzsz+FXKvrpk+/lR6BTJOGTSeHlpXxVlk57gQw2KEpkn2WMwmr9cgP2B/srAcGN9QudRNYE9CVyFosjAp8hTBouRwOPTxMYhRFpXbEtwPyE5VjtTdlw//trxba3hz4/Vsb2z3ht7A6c3Ho3nPto3l0jDHc2thPKn6bKLXEeQowt8RjWBHo6R4C9sWow8lRpMorq4ZyZ//hdj9IIyRXXUXYxRi2NkYfaDjlhBW3ZQfORD6WMQYs9kfAAAA//8DAFBLAwQUAAYACAAAACEA9mC0QbgHAAARIgAAEwAAAHhsL3RoZW1lL3RoZW1lMS54bWzsWs2PG7cVvwfI/0DMXdbM6HthOdCnN/bueuGVXeRISZSGXs5wQFK7KxQBCufUS4ECadFLgd56KIoGaIAGueSPMWAjTf+IPHJGmuGKir3+QJJidy8z1O89/ua9x8c3j3P3k6uYoQsiJOVJ1wvu+B4iyYzPabLsek8m40rbQ1LhZI4ZT0jXWxPpfXLv44/u4gMVkZggkE/kAe56kVLpQbUqZzCM5R2ekgR+W3ARYwW3YlmdC3wJemNWDX2/WY0xTTyU4BjUPlos6IygiVbp3dsoHzG4TZTUAzMmzrRqYkkY7Pw80Ai5lgMm0AVmXQ/mmfPLCblSHmJYKvih6/nmz6veu1vFB7kQU3tkS3Jj85fL5QLz89DMKZbT7aT+KGzXg61+A2BqFzdq6/+tPgPAsxk8acalrDNoNP12mGNLoOzSobvTCmo2vqS/tsM56DT7Yd3Sb0CZ/vruM447o2HDwhtQhm/s4Ht+2O/ULLwBZfjmDr4+6rXCkYU3oIjR5HwX3Wy1280cvYUsODt0wjvNpt8a5vACBdGwjS49xYInal+sxfgZF2MAaCDDiiZIrVOywDOI4l6quERDKlOG1x5KccIlDPthEEDo1f1w+28sjg8ILklrXsBE7gxpPkjOBE1V13sAWr0S5OU337x4/vWL5/958cUXL57/Cx3RZaQyVZbcIU6WZbkf/v7H//31d+i///7bD1/+yY2XZfyrf/7+1bff/ZR6WGqFKV7++atXX3/18i9/+P4fXzq09wSeluETGhOJTsglesxjeEBjCps/mYqbSUwiTC0JHIFuh+qRiizgyRozF65PbBM+FZBlXMD7q2cW17NIrBR1zPwwii3gMeesz4XTAA/1XCULT1bJ0j25WJVxjzG+cM09wInl4NEqhfRKXSoHEbFonjKcKLwkCVFI/8bPCXE83WeUWnY9pjPBJV8o9BlFfUydJpnQqRVIhdAhjcEvaxdBcLVlm+OnqM+Z66mH5MJGwrLAzEF+Qphlxvt4pXDsUjnBMSsb/AiryEXybC1mZdxIKvD0kjCORnMipUvmkYDnLTn9IYbE5nT7MVvHNlIoeu7SeYQ5LyOH/HwQ4Th1cqZJVMZ+Ks8hRDE65coFP+b2CtH34Aec7HX3U0osd78+ETyBBFemVASI/mUlHL68T7i9HtdsgYkry/REbGXXnqDO6OivllZoHxHC8CWeE4KefOpg0OepZfOC9IMIssohcQXWA2zHqr5PiIQySdc1uynyiEorZM/Iku/hc7y+lnjWOImx2Kf5BLxuhe5UwGJ0UHjEZudl4AmF8g/ixWmURxJ0lIJ7tE/raYStvUvfS3e8roXlvzdZY7Aun910XYIMubEMJPY3ts0EM2uCImAmmKIjV7oFEcv9hYjeV43Yyim3sBdt4QYojKx6J6bJ64qfEywEv/x5ap8PVvW4Fb9LvbMvrxxeq3L24X6Ftc0Qr5JTAtvJbuK6LW1uSxvv/7602beWbwua24LmtqBxvYJ9kIKmqGGgvClaPabxE+/t+ywoY2dqzciRNK0fCa818zEMmp6UaUxu+4BpBJf6eWACC7cU2MggwdVvqIrOIpxCfygwXcylzFUvJUq5hLaRGTb9VHJNt2k+reJjPs/anaa/5GcmlFgV434DGk/ZOLSqVIZutvJBzW9D3bBdmlbrhoCWvQmJ0mQ2iZqDRGsz+BoSunP2flh0HCzaWv3GVTumAGpbr8B7N4K39a7XqGeMoCMHNfpc+ylz9ca72jnv1dP7jMnKEQCtxV1PdzTXvY+nny4LtTfwtEXCOCULK5uE8ZUp8GQEb8N5dJb77j8VcDf1dadwqUVPm2KzGgoarfaH8LVOItdyA0vKmYIl6BLWeAiLzkMznHa9BfSN4TJOIXikfvfCbAmHLzMlshX/NqklFVINsYwyi5usk/knpooIxGjc9fTzb8OBJSaJZOQ6sHR/qeRCveB+aeTA67aXyWJBZqrs99KItnR2Cyk+SxbOX43424O1JF+Bu8+i+SWaspV4jCHEGq1Ae3dOJRwfBJmr5xTOw7aZrIi/aztTnv2tQ64iH2OWRjjfUsrZPIObDWVLx9xtbVC6y58ZDLprwulS77DvvO2+fq/Wliv2x06xaVppRW+b7mz64Xb5EqtiF7VYZbn7es7tbJIdBKpzm3j3vb9ErZjMoqYZ7+ZhnbTzUZvae6wISrtPc4/dtpuE0xJvu/WD3PWo1TvEprA0gW8Ozstn23z6DJLHEE4RVyw77WYJ3JnSMj0VxrdTPl/nl0xmiSbzuS5Ks1T+mCwQnV91vdBVOeaHx3k1wBJAm5oXVthW0Fnt2YJ6s8tFswW7Fc7K2Gv1qi28ldgcs26FTWvRRVtdbU7Uda1uZtYOy57apGFjKbjatSK0yQWG0jk7zM1yL+SZK5VX2nCFVoJ2vd/6jV59EDYGFb/dGFXqtbpfaTd6tUqv0agFo0bgD/vh50BPRXHQyL58GMNpEFvn3z+Y8Z1vIOLNgdedGY+r3HzjUDXeN99ABOH+byDAkUArHAX1sBcOKoNh0KzUw2Gz0m7VepVB2ByGPdi0m+Pe5x66MOCgPxyOx42w0hwAru73GpVevzaoNNujfjgORvWhD+B8+7mCtxidc3NbwKXhde9HAAAA//8DAFBLAwQUAAYACAAAACEAT7BqFkYKAACvbwAADQAAAHhsL3N0eWxlcy54bWzsHduOm0b0vVL/AZGoD1FYLgbW3qw3zV5QI6VRpKRSpWwVsTb2onBxASfeVH3p9/Sr+iU9M4AZrgY8YBPtrrRrMMyc+5zLcDh/ubEt5ovh+abrTFnxRGAZw5m5c9NZTtnfPmjcmGX8QHfmuuU6xpR9MHz25cWPP5z7wYNlvL83jICBIRx/yt4HweqM5/3ZvWHr/om7Mhz4ZuF6th7Aobfk/ZVn6HMf3WRbvCQIKm/rpsOGI5zZszqD2Lr3eb3iZq690gPzzrTM4AGPxTL27Oz10nE9/c4CUDeirM+Yjah6ErPx4knw2dw8tjnzXN9dBCcwLu8uFubMyIM74Se8PktGgpHbjSQqvCClcN94LUeSec/4YiL2sRfnztrW7MBnZu7aCaassj3FhN+8nk9ZWWaZkClX7hzI9In56c+1G7z4759/ww+3zDPmyfMnT4QTQfjEvCj8/pbbdUU4Fhf+e/kSD/TzJ4blYyhJkEZZkDIQPGMyEz6LgK43vqhmcP749I/5nLdt/gF+XvwMHEVScpaQRVSn7MennOFwb988F9MXF2EgqkoahVsg5+2WjC9uufSJQjKIqlpOh4gXJCW2pypozUcicXG+cJ1EMkSYCWvC2WfH/epo6DtQf5AXdNnFuf+N+aJbcEZEkM5cy/WYAPQa5AWfcXTbCK94tQpcn3mre577FV270G3Tegi/k9AJbA+ii20TtBOd5MNpwr9rdFXFhAKmFs0Zt7PhoUP0vOXdlNU0Af9kZvRM3SpELoVHPKokt7r9jiRDHrAQtL0AE7OUbIbXZG+02o9AyggeJcc0Tduf6u0Yt5Wm/fmeR20PtucFilDbZqwPJSdlB9rJUkrXCSGPjQvdUQmdbiweWLV9MGimZW1XVFFGJhLOXJyD9xEYnqPBARN9/vCwAgPpgKMU2jh83Y6rl57+IEpK/Rt81zLnCIrlFTbLEY7aq5vrUzzMXfSF6cyNjQErPqx+yOQSACMDXAe42nNFQFxeo19as0UygUWiQ6SKpukNn5h7GvrpknDxRCMNfqlPxAQmcjg5+WQyGU9G4liRRHU8koXRDYe9gJh/3RK2KRiI6AKWLxrasRWkxmAcB1OwDPYihAcmex3LiA0kmP8715tDeByHVBLykcNzF+eWsQjAsnrm8h79D9wV/L1zgwBiyIvzuakvXUe3kO2N7yDvhLgaQugpaxtzc23DsOHymgUOTZKao+Z9AE0MTM07Qsh3A55G+WjAqQkI5hZm1sEhbysBTaQsZlZj6rQR5eAesjk1BDkGpvL6PKMqLy+Q98rr60p7LVhLlfQgIBcr6EFBeeQ49rkIIa2xQuzHxwYTdMydBothXQvSfLnNGsKatqdLM5hBohYX2i3SWyw6maOh+HQDzN6LaadeUg7nHV5fUza3X94poB25t+AtzwzLeo/c2t8XicsMHsFmQaT7ocaEEr+oGIE+QiIi+hh6x+EBEKzsJrH0JkZfrayHt2v7zvA0XHjCU+CzKFGTHF1itz45fmWZS8c2UBALMOEb3nluYMwCXBgLY0QSuxBXAs0JqrY0x5PZLHYiLCUIw8eESkCI+O4QZJTHRxn66AhjHB/FGMfHBMYoptFjAjBfPX31wdjggYAL/GZRjheqq0T8gxpOAhmA2QFk965nfgMUUWViBrwyoKoHtcvAnBFndoGMCjX9gdyEmGWQAWU7JiZ2tdlGnCdkEhSG1NxKYFNSl9eztCSS/C4GcbXVUcZyZ59RtjNU1Sqh7QP0DN9bwUnIA+hZQmI4oCQPuxhAAwtU04z0DRCqLSihuS40Vk3EBgVmpJEABxw54q340T8mNOh/elD65830sDhQtLxQVWbQiQEpc5lJgiWgPhaN1gAaKjBJVAC0gYYJIv2lxh4IoZHHAA5h1iiBs8tA5yiW9TxaaVi3ZCV9keyiEhm5Bp4n0PzQK2EC9L6LYco56c4SdCM1hPRTwqPSNuz2saPNamF8TNhbMGIVIpOOebcRYEU82NoTL5f+I1fbKITYx15T0ltSRNoalpScEFJcHY3VkZNGktG5VvZkKjtfkzoQncaSTIjJQFegMqkXU4mx3CI0MPNYhmX1CtUxkt+tplPIBxyPNlFxpQm3o7PkHuXc0oAzZETgIqay6GiTflQdoJjfL8qiN0lTl3nMw8pk1PaY0jWVfnIXqMIVVcgIVdwhHM3Nf+2SUIHIFAa7tWKXnFRTBrxJerhNECzjp5Vy8Vnn3CHrkahOUj/aih4sGhLI/RM5W3AegA42KtjRT3R0Vj2KnqYL5bX+6ngEBvBQtoFKMZ+KhLS3UiTtUDgXVw07NKxZnT8ACKESUeFf/8UZiiFhSudJ9h805q2XnKu/EocPX+cW4uOK69vGw4TODjgaK8NiaIWN+jpUtWtsv1xwW0lCJj82/4OuLpUJ02PVH23UzPoKyR5EatsuSrUAiVhPGy96QKa/LWF192Ae7c68btLY4qCdL2JH9hEsf61XjTLYEXO+H12nlxVuvE+HPmcguu+JM30Zrp78FRrlk1J9gaZfA9qUWIoGbJn5DtCQGkUelTn9PvZ7E657z4+ElOz1PtIHWFpuIgTVjCOjAxSdK7ZQtXL4oK/QFh3AbOB7IqFb2m7moGZ7xjvPWJgb4lGt7jbqUX4SpXobIrVUAu3EG+HhkhXVJrsb9ngipZuYg0QEJG/gynMAtnQoZETVqoNtxTUAb1QbLN1k0F3SswUK+24vTheS6EUe1bt5m2ytKa110nPIewCWntu9J7CpmlKpjOcE4YD7UbBT2CjKrodjTn6+QxxzYjcoHEsclFQIdZhkSXOZrINLfymG3ErTNotVakH6yzNQw6W8LkIv20DjKRdClMpB7qYPBoUn/spB7r5BRsv8QgdlY9pyQDQdKfat6zz+tleejLbzyqPOMtBLhmigk2qfs208w6AOzlP2F2g07Fmm8zlOcKLwb21a0IUVNZMZoxYH2Xveon44FpERJW7ItLcBOOYbooGPBLtN4UTcHD7TBjrudiqcSPJkIqvKRFKFsSyeCrhVfNwiPds0GZpTRo2K6/dNLezSymPQyuBTw87KuKt9rhXzIwxhA+ue6ADGPOoT/Cgrj/K6h96mG67HXcp7sSekDI/A3o1VSVXVU+F0pJzi7v2RvTt+q3RYTIQTEainnk4URVEVQRGgszJ6pqSoS301LRM8SruPP65B7DGsg4/2H704YliW4dGnK/Z7+9QnJDHgkwfovWa4u+Y2OACNmhsLfW0FH7ZfTtnk86+4tzwEm9FV78wvboCHmLLJ5zeogT28EgrsL/R9fONDv3n4z6w9c8r+dXN5Orm+0SRuLFyOOXlkKNxEubzmFPnq8vpamwiScPU3hBXoJXBn8E6pPd6thl8GB80mRfnMt+ANbF6EbAT8++TclCUOQvDx6gFgk7CjSOSVIgqcNhJETlb1MTdWRwqnKaJ0rcqXN4qmELArLd/BJvCiGL7NDQGvnAWmbUB0FvMq5hB5FpgEhxVI8DEn+ORNexf/AwAA//8DAFBLAwQUAAYACAAAACEA3ML5ck4CAABLBgAAFAAAAHhsL3NoYXJlZFN0cmluZ3MueG1sjFXbbtswDH0fsH8g/DKgWKwsG4ItcFyk7QbspR3a7ANkmbG1WpdJclL//ahcgMVxgvgpschDnnMoOrt9Uw2s0Xlp9Dz5lI4TQC1MKXU1T34vf4y+JuAD1yVvjMZ50qFPbvP37zLvA1Cu9vOkDsHOGPOiRsV9aixqOlkZp3igv65i3jrkpa8Rg2rYZDyeMsWlTkCYVod58m2aQKvl3xbvdy8+T5M88zLPQv79jfA8wjYbJuPJF7gzVmoBlTOtzVjIMxZDd+HLWvp9LP2wzgQUAcsUfjXICUbxVwROhW0HBVKTCK0ntiBD2sd6chXX0vNA4vTP9nAeG8IHInk28pErvJzdmdaBHghbiK1AoFtVoGM/7xaPJ3wdX2MDJQ/o4ehZOaP60WXJlGIdPb2T6OXMWy7IYzLLo1tjkgdDiFdFPlD9WL1f8MCgNk2J7oMfpPmAPkg9LLMzf0jgy/qFGqPTQ4H3rXM00H26+bF9WwMaI3gD4kzCMwqUNuyt6PdzON36cNJsTYPXf0mchSPAgdE69AxGg9RrIwUytyt/Iq+K9+WKwOfoz82Z9MvMj6WyQ2SOQ85IODxiL20RTCDhT0ZnxEawKNdci754w0jLYZgXWdFotXTPUdnGdIizqyYabuCwM3xrbdORF7udRpZFxePU4Zuoua4QXNS39Vh+vA6crgpdsxU6XhBy0cX5Xcu4duNycljKAIK7EswKCq5f4xIOqFCH6wsY6tBtJC09u9t91F+fe77ZbNIDi0giFSdbY1ju//xi9DHI/wEAAP//AwBQSwMEFAAGAAgAAAAhANx9+uUTAQAAqQEAACMAAAB4bC93b3Jrc2hlZXRzL19yZWxzL3NoZWV0MS54bWwucmVsc4SQy2rDMBBF94X+g9Gim1LLSSD0EdmUvsiim5KuyyBPLBFpZKRJE/99FZeWBApd3nmcuXMXzd674hNjsoGUmJSVKJB0aC11Sryvnq+uRZEYqAUXCJUYMImmPj9bvKEDzkvJ2D4VmUJJCcPc30qZtEEPqQw9Uu6sQ/TAWcZO9qA30KGcVtVcxmOGqE+YxbJVIi7biShWQ58v/88O67XV+Bj01iPxHyekyaToLG0yFGKH/Ivd7XYl7rUB6jACY6mDz2YTfxxUKg1712jbqul8fgG+v9PbGHNSg5rObsaCy8OzSs2qUYE+hKNekEbc5YOByN+LgdhSNqjunfvx8Rra/OLTnjESOCHrhTwJuP4CAAD//wMAUEsDBBQABgAIAAAAIQDfKws04QAAADwCAAAQAAAAeGwvY2FsY0NoYWluLnhtbGSRy2rDMBBF94H+g5h9I4/TJmmxnEWh61KaDxDyJDboYSQR0r+vErBdMhuBji53zqDmcHVWXCimIXgFuK5AkDehG/xZwfHn83kPImXtO22DJwW/lODQPq0ao6356PXgRWnwSUGf8/guZTI9OZ3WYSRfXk4hOp3LNZ5lGiPpLvVE2VlZV9VWulIAbWNEVPC9QRBDkQBhb6ec+WbiZczCv+b8kiz694aZ1G+MlI0eMjtGtoy8MvLCyOS5TK9ZZtpxyTBnZM7InJE5I3NG5ozMGZkzMmf85yznf2//AAAA//8DAFBLAwQUAAYACAAAACEAQ029rD8BAABbAgAAEQAIAWRvY1Byb3BzL2NvcmUueG1sIKIEASigAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjJJRS8MwFIXfBf9DyXubpuuGhLYDlT2IA8GJ4ltI7rZgk4Yk2u3fm7ZbrcwHH3PPud8995JieVB19AXWyUaXiCQpikDzRki9K9HLZhXfoMh5pgWrGw0lOoJDy+r6quCG8sbCk20MWC/BRYGkHeWmRHvvDcXY8T0o5pLg0EHcNlYxH552hw3jH2wHOEvTBVbgmWCe4Q4Ym5GITkjBR6T5tHUPEBxDDQq0d5gkBP94PVjl/mzolYlTSX80YadT3Clb8EEc3QcnR2Pbtkk762OE/AS/rR+f+1VjqbtbcUBVITjlFphvbPUAzkGBJ5XuejVzfh0OvZUgbo9n06UQSH3wAQciClHoEPysvM7u7jcrVGVpNo8JiUm6ITNKFjTP37u5v/q7aENBnab/m5hnNJ9PiGdAVeCL71B9AwAA//8DAFBLAwQUAAYACAAAACEAYUkJEIkBAAARAwAAEAAIAWRvY1Byb3BzL2FwcC54bWwgogQBKKAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACckkFv2zAMhe8D+h8M3Rs53VAMgaxiSFf0sGEBkrZnTaZjobIkiKyR7NePttHU2XrqjeR7ePpESd0cOl/0kNHFUInlohQFBBtrF/aVeNjdXX4VBZIJtfExQCWOgOJGX3xSmxwTZHKABUcErERLlFZSom2hM7hgObDSxNwZ4jbvZWwaZ+E22pcOAsmrsryWcCAINdSX6RQopsRVTx8NraMd+PBxd0wMrNW3lLyzhviW+qezOWJsqPh+sOCVnIuK6bZgX7Kjoy6VnLdqa42HNQfrxngEJd8G6h7MsLSNcRm16mnVg6WYC3R/eG1XovhtEAacSvQmOxOIsQbb1Iy1T0hZP8X8jC0AoZJsmIZjOffOa/dFL0cDF+fGIWACYeEccefIA/5qNibTO8TLOfHIMPFOONuBbzpzzjdemU/6J3sdu2TCkYVT9cOFZ3xIu3hrCF7XeT5U29ZkqPkFTus+DdQ9bzL7IWTdmrCH+tXzvzA8/uP0w/XyelF+LvldZzMl3/6y/gsAAP//AwBQSwECLQAUAAYACAAAACEAnixsb2sBAAAQBQAAEwAAAAAAAAAAAAAAAAAAAAAAW0NvbnRlbnRfVHlwZXNdLnhtbFBLAQItABQABgAIAAAAIQC1VTAj9AAAAEwCAAALAAAAAAAAAAAAAAAAAKQDAABfcmVscy8ucmVsc1BLAQItABQABgAIAAAAIQB/+yDPmQMAAPEIAAAPAAAAAAAAAAAAAAAAAMkGAAB4bC93b3JrYm9vay54bWxQSwECLQAUAAYACAAAACEAkgeU7AQBAAA/AwAAGgAAAAAAAAAAAAAAAACPCgAAeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHNQSwECLQAUAAYACAAAACEA6lOHcQsTAAC7bwAAGAAAAAAAAAAAAAAAAADTDAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsBAi0AFAAGAAgAAAAhAPZgtEG4BwAAESIAABMAAAAAAAAAAAAAAAAAFCAAAHhsL3RoZW1lL3RoZW1lMS54bWxQSwECLQAUAAYACAAAACEAT7BqFkYKAACvbwAADQAAAAAAAAAAAAAAAAD9JwAAeGwvc3R5bGVzLnhtbFBLAQItABQABgAIAAAAIQDcwvlyTgIAAEsGAAAUAAAAAAAAAAAAAAAAAG4yAAB4bC9zaGFyZWRTdHJpbmdzLnhtbFBLAQItABQABgAIAAAAIQDcffrlEwEAAKkBAAAjAAAAAAAAAAAAAAAAAO40AAB4bC93b3Jrc2hlZXRzL19yZWxzL3NoZWV0MS54bWwucmVsc1BLAQItABQABgAIAAAAIQDfKws04QAAADwCAAAQAAAAAAAAAAAAAAAAAEI2AAB4bC9jYWxjQ2hhaW4ueG1sUEsBAi0AFAAGAAgAAAAhAENNvaw/AQAAWwIAABEAAAAAAAAAAAAAAAAAUTcAAGRvY1Byb3BzL2NvcmUueG1sUEsBAi0AFAAGAAgAAAAhAGFJCRCJAQAAEQMAABAAAAAAAAAAAAAAAAAAxzkAAGRvY1Byb3BzL2FwcC54bWxQSwUGAAAAAAwADAAPAwAAhjwAAAAA';

  // Decode base64 to ArrayBuffer
  const bin = atob(TPL);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);

  // Load template with ExcelJS (preserves all formatting, fonts, fills, borders)
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(buf.buffer);
  const ws = wb.getWorksheet(1);

  // Fill data rows starting at row 11
  // Template columns: B=2 C=3 D=4 G=7 N=14 P=16 Q=17, R=18 has formula =Pn*Qn
  data.forEach((r, i) => {
    const row = 11 + i;
    const rate   = rates[r.currency] || 1;
    const amount = parseFloat(r.amount) || 0;

    ws.getCell(row, 2).value  = i + 1;                      // B: receipt number
    ws.getCell(row, 3).value  = formatDateDisplay(r.date);   // C: date
    ws.getCell(row, 4).value  = phase;                       // D: phase
    ws.getCell(row, 7).value  = r.description || '';         // G: description
    ws.getCell(row, 14).value = r.currency || '';             // N: currency
    ws.getCell(row, 16).value = amount;                       // P: amount
    ws.getCell(row, 17).value = rate;                         // Q: rate
    // R column keeps its existing formula from template
  });

  // Clear placeholder text from unused rows
  for (let i = data.length; i < 20; i++) {
    const row = 11 + i;
    ws.getCell(row, 3).value  = null;   // clear "dd/mm/yyyy"
    ws.getCell(row, 4).value  = null;   // clear "Please select phase"
    ws.getCell(row, 14).value = null;   // clear "Please select currency"
  }

  // Write to buffer
  const outBuf = await wb.xlsx.writeBuffer();
  return new Uint8Array(outBuf);
}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PDF BUILDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function buildPDF(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();

  for (let i = 0; i < data.length; i++) {
    if (i > 0) doc.addPage();
    const r = data[i];

    doc.setFillColor(20, 20, 20);
    doc.rect(0, 0, W, 14, 'F');
    doc.setTextColor(200, 200, 200);
    doc.setFontSize(8);
    doc.text(`BOP Expenses  ¬∑  Receipt ${i + 1} of ${data.length}`, 6, 5.5);
    doc.setTextColor(244, 219, 39);
    doc.text(`${r.description || ''} ¬∑ ${formatDateDisplay(r.date)} ¬∑ ${r.currency || ''} ${r.amount || ''}`, 6, 10.5);

    try {
      const img = new Image();
      img.src = r.photoBase64;
      await new Promise(res => { img.onload = res; img.onerror = res; });
      if (img.naturalWidth) {
        const margin = 6;
        const aw = W - margin * 2;
        const ah = H - 14 - margin * 2;
        const ir = img.naturalWidth / img.naturalHeight;
        const ar = aw / ah;
        let dw, dh;
        if (ir > ar) { dw = aw; dh = aw / ir; }
        else         { dh = ah; dw = ah * ir; }
        const x = margin + (aw - dw) / 2;
        const y = 14 + margin + (ah - dh) / 2;
        doc.addImage(r.photoBase64, r.photoBase64.includes('image/png') ? 'PNG' : 'JPEG', x, y, dw, dh);
      }
    } catch (_) {}
  }

  return doc.output('arraybuffer');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSettings() {
  document.getElementById('settings-receipt-count').textContent =
    `${receipts.length} receipt${receipts.length !== 1 ? 's' : ''}`;
  document.getElementById('settings-modal').classList.add('active');
}

function closeSettings() {
  document.getElementById('settings-modal').classList.remove('active');
}

async function clearAllData() {
  if (!confirm('Delete ALL receipts? This cannot be undone.')) return;
  await dbClear('receipts');
  receipts = [];
  closeSettings();
  renderHome();
  showToast('All receipts deleted');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  NAV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
}

function showHome() {
  currentId = null;
  renderHome();
  showScreen('home');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2600);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(reg => {
    // Force check for updated service worker
    reg.update();
  }).catch(() => {});
}

// Version indicator for debugging cache issues
const APP_VERSION = 'v9';
console.log('BOP Expenses ' + APP_VERSION);

init();
</script>
</body>
</html>